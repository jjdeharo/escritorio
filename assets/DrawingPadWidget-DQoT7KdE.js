import{r as i,j as s}from"./vendor-react-CvxLrFbY.js";import{l as Ct}from"./index-BRUjA2Tl.js";import{u as ze}from"./vendor-react-i18next-CV9wn5jO.js";import{W as Ye,Y as Xe,Z as De,_ as Ee,$ as $e,a0 as Be,a1 as Oe,a2 as We,a3 as He,a4 as Le,I as Ae,a5 as Fe,T as Ue,a6 as qe,R as Je}from"./vendor-lucide-react-CYRm5Z9O.js";import"./vendor-clsx-DMbM62ou.js";import"./vendor-react-dom-ovwEKgq_.js";import"./vendor-scheduler-SPyfQU6S.js";import"./vendor-i18next-http-backend-BlWUewvL.js";import"./vendor-react-rnd-CJIym3is.js";import"./vendor-react-draggable-CHzIUO8G.js";import"./vendor-prop-types-Chjiymov.js";import"./vendor-re-resizable-Bd8fNV1d.js";import"./vendor-dnd-kit-core-C4pUYSBz.js";import"./vendor-dnd-kit-utilities-CZrAEsTl.js";import"./vendor-dnd-kit-accessibility-DKV5GxcV.js";import"./vendor-dnd-kit-sortable-BobZZm17.js";import"./vendor-fflate-PjZAcS34.js";import"./vendor-framer-motion-FfyGqyL8.js";import"./vendor-motion-dom-DtvSSoo0.js";import"./vendor-motion-utils-CjIqCkNq.js";import"./vendor-i18next-Bvlggjj8.js";import"./vendor-i18next-browser-languagedetector-OJKzRF51.js";import"./vendor-html-parse-stringify-C3VvPRF8.js";import"./vendor-void-elements-SshaXqDN.js";const xt=()=>{const{t:u}=ze(),m=i.useRef(null),f=i.useRef(null),[Q,W]=i.useState(!1),[N,we]=i.useState("#000000"),[j,me]=i.useState(5),[_,V]=i.useState("draw"),[h,S]=i.useState("pencil"),[p,ee]=i.useState(null),[v,fe]=i.useState(0),[C,pe]=i.useState(0),[T,Y]=i.useState(null),[te,H]=i.useState(!1),[L,X]=i.useState(""),[ne,xe]=i.useState(0),[ae,be]=i.useState(0),re=i.useRef(null),[A,ve]=i.useState(!0),[M,F]=i.useState({x:0,y:0}),[k,Ce]=i.useState(!1),y=i.useRef(null),[U,q]=i.useState(!1),D=i.useRef(typeof window<"u"&&window.devicePixelRatio||1),E=i.useRef(M),J=i.useRef(U);E.current=M,J.current=U;const b=i.useCallback(()=>{A&&ve(!1)},[A]),[z,I]=i.useState(null),$=i.useCallback((e,t)=>{if(!m.current||!y.current)return;const n=m.current,a=y.current,r=n.getContext("2d");if(r){r.clearRect(0,0,n.width,n.height);const o=D.current||1,c=Math.max(0,Math.round(e*o)),l=Math.max(0,Math.round(t*o)),g=Math.min(n.width,a.width-c),d=Math.min(n.height,a.height-l);g>0&&d>0&&r.drawImage(a,c,l,g,d,0,0,g,d)}},[]),ke=i.useCallback(()=>{F({x:0,y:0}),$(0,0)},[$]),ye=i.useCallback(()=>{Ce(!k),k||I(null)},[k]),K=i.useCallback(()=>(y.current||(y.current=document.createElement("canvas")),y.current),[]),B=i.useCallback(()=>{const e=m.current;if(!e)return;const t=K(),n=E.current,a=D.current||1,r=Math.max(e.width+Math.abs(Math.round(n.x*a)),t.width||0),o=Math.max(e.height+Math.abs(Math.round(n.y*a)),t.height||0);if(t.width<r||t.height<o){const l=document.createElement("canvas");l.width=r,l.height=o;const g=l.getContext("2d");if(g){J.current&&t.width>0&&t.height>0&&g.drawImage(t,0,0),t.width=r,t.height=o;const d=t.getContext("2d");d&&(d.clearRect(0,0,r,o),d.drawImage(l,0,0))}}const c=t.getContext("2d");if(c){const l=Math.max(0,Math.round(n.x*a)),g=Math.max(0,Math.round(n.y*a));c.drawImage(e,0,0,e.width,e.height,l,g,e.width,e.height)}q(!0)},[K]),se=i.useCallback(e=>{const t=m.current;if(!t)return{x:0,y:0};const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}},[]),ie=i.useCallback(e=>{const t=m.current;if(!t)return{x:0,y:0};const n=t.getBoundingClientRect(),a=t.width/n.width,r=t.height/n.height;return{x:(e.clientX-n.left)*a+M.x*a,y:(e.clientY-n.top)*r+M.y*r}},[M]),Me=i.useCallback(e=>{const t=m.current;if(!t)return{x:0,y:0};const n=t.getBoundingClientRect(),a=t.width/n.width,r=t.height/n.height;return{x:(e.clientX-n.left)*a+M.x*a,y:(e.clientY-n.top)*r+M.y*r}},[M]),oe=i.useCallback((e=!1)=>{const t=m.current,n=f.current;if(!t||!n)return;let a=null;if(e&&(a=n.getImageData(0,0,t.width,t.height)),e||n.clearRect(0,0,t.width,t.height),p){const r=t.width/p.width,o=t.height/p.height,c=Math.min(r,o),l=(t.width-p.width*c)/2,g=(t.height-p.height*c)/2;if(e&&a){const d=document.createElement("canvas");d.width=t.width,d.height=t.height;const x=d.getContext("2d");x&&(x.drawImage(p,0,0,p.width,p.height,l,g,p.width*c,p.height*c),x.putImageData(a,0,0),n.clearRect(0,0,t.width,t.height),n.drawImage(d,0,0))}else n.drawImage(p,0,0,p.width,p.height,l,g,p.width*c,p.height*c)}else e&&a&&n.putImageData(a,0,0)},[p]);i.useEffect(()=>{const e=m.current;if(!e)return;const t=()=>{const r=e.offsetWidth,o=e.offsetHeight,c=(typeof window<"u"?window.devicePixelRatio:1)||1;if(D.current=c,r<=0||o<=0)return;const l=Math.round(r*c),g=Math.round(o*c);if(e.width!==l||e.height!==g){const d=E.current,x=Math.max(0,Math.round(d.x*c)),R=Math.max(0,Math.round(d.y*c)),w=K();((he,ge)=>{if(w.width>=he&&w.height>=ge)return;const P=document.createElement("canvas");P.width=Math.max(he,w.width),P.height=Math.max(ge,w.height);const Z=P.getContext("2d");Z&&w.width>0&&w.height>0&&Z.drawImage(w,0,0),w.width=P.width,w.height=P.height;const G=w.getContext("2d");G&&Z&&(G.clearRect(0,0,w.width,w.height),G.drawImage(P,0,0))})(x+e.width,R+e.height);const O=w.getContext("2d");O&&e.width>0&&e.height>0&&(O.drawImage(e,0,0,e.width,e.height,x,R,e.width,e.height),J.current=!0,q(!0)),e.width=l,e.height=g,f.current=e.getContext("2d"),$(d.x,d.y)}},n=e.getContext("2d");if(!n)return;f.current=n,t();const a=new ResizeObserver(()=>{t()});return a.observe(e.parentElement||e),window.addEventListener("resize",t),()=>{a.disconnect(),window.removeEventListener("resize",t)}},[]),i.useEffect(()=>{f.current&&(f.current.globalCompositeOperation=_==="draw"?"source-over":"destination-out")},[_]);const je=e=>{if(b(),k){const a=se(e);I(a);return}if(h==="text"&&te||!f.current||!m.current)return;const{x:t,y:n}=ie(e);h==="text"?(H(!0),xe(t),be(n),X(""),Y(f.current.getImageData(0,0,m.current.width,m.current.height)),setTimeout(()=>re.current?.focus(),0)):["line","rectangle","circle","arrow"].includes(h)?(fe(t),pe(n),Y(f.current.getImageData(0,0,m.current.width,m.current.height))):(f.current.beginPath(),f.current.moveTo(t,n)),W(!0)},ce=(e,t,n,a,r)=>{e.save(),e.beginPath(),e.translate(t,n),e.rotate(a),e.moveTo(0,0),e.lineTo(-r,-r/2),e.lineTo(-r,r/2),e.closePath(),e.fill(),e.restore()},Se=e=>{if(k&&z){const r=se(e),o=r.x-z.x,c=r.y-z.y;if(U&&y.current){const d=y.current.getContext("2d"),x=m.current;if(d&&x){const R=E.current,w=D.current||1,ue=Math.max(0,Math.round(R.x*w)),O=Math.max(0,Math.round(R.y*w));d.drawImage(x,0,0,x.width,x.height,ue,O,x.width,x.height)}}const l={x:M.x-o,y:M.y-c};F(l),$(l.x,l.y),I(r);return}if(!Q||!f.current)return;const{x:t,y:n}=ie(e),a=f.current;if(a.lineWidth=j,a.strokeStyle=N,a.fillStyle=N,T&&["line","rectangle","circle","arrow"].includes(h)){a.putImageData(T,0,0);const r=t-v,o=n-C;switch(h){case"line":a.beginPath(),a.moveTo(v,C),a.lineTo(t,n),a.stroke();break;case"rectangle":a.strokeRect(v,C,r,o);break;case"circle":const c=(v+t)/2,l=(C+n)/2,g=Math.abs(r/2),d=Math.abs(o/2);a.beginPath(),a.ellipse(c,l,g,d,0,0,2*Math.PI),a.stroke();break;case"arrow":a.beginPath(),a.moveTo(v,C),a.lineTo(t,n),a.stroke();const x=Math.atan2(n-C,t-v);ce(a,t,n,x,j*4);break}}else if(h!=="text"){switch(h){case"pencil":a.lineCap="round",a.lineJoin="round",a.lineTo(t,n),a.stroke();break;case"marker":a.lineCap="square",a.lineJoin="miter",a.lineTo(t,n),a.stroke();break;case"spray":for(let r=0;r<15;r++){const o=Math.random()*2*Math.PI,c=Math.random()*j,l=t+c*Math.cos(o),g=n+c*Math.sin(o);a.fillRect(l,g,1,1)}break}a.beginPath(),a.moveTo(t,n)}},le=e=>{if(k){I(null);return}if(!f.current)return;const t=f.current,{x:n,y:a}=Me(e);let r=n,o=a;if(["line","rectangle","circle","arrow"].includes(h)&&(isNaN(n)||isNaN(a))&&(r=v,o=C),T&&["line","rectangle","circle","arrow"].includes(h)){t.putImageData(T,0,0);const c=r-v,l=o-C;switch(h){case"line":t.beginPath(),t.moveTo(v,C),t.lineTo(r,o),t.stroke();break;case"rectangle":t.strokeRect(v,C,c,l);break;case"circle":const g=(v+r)/2,d=(C+o)/2,x=Math.abs(c/2),R=Math.abs(l/2);t.beginPath(),t.ellipse(g,d,x,R,0,0,2*Math.PI),t.stroke();break;case"arrow":t.beginPath(),t.moveTo(v,C),t.lineTo(r,o),t.stroke();const w=Math.atan2(o-C,r-v);ce(t,r,o,w,j*4);break}Y(null)}else h==="text"||t.closePath();W(!1),B()},Ie=()=>{const e=m.current,t=f.current;if(e&&t&&window.confirm(u("widgets.drawing_pad.clear_confirm"))){if(ee(null),t.clearRect(0,0,e.width,e.height),H(!1),X(""),y.current){const n=y.current.getContext("2d");n&&n.clearRect(0,0,y.current.width,y.current.height)}q(!1),F({x:0,y:0}),I(null)}},Re=e=>{b();const t=e.target.files?.[0];if(!t)return;const n=new FileReader;n.onload=a=>{const r=new Image;r.onload=()=>{ee(r),oe(),B()},r.src=a.target?.result},n.readAsDataURL(t)},Ne=()=>{const e=m.current;if(e){const t=e.toDataURL("image/png"),n=document.createElement("a");n.href=t,n.download=u("widgets.drawing_pad.default_filename"),document.body.appendChild(n),n.click(),document.body.removeChild(n)}},_e=i.useCallback((e,t,n)=>{const a=f.current;!a||!e||(a.font=`${j*2}px Arial`,a.fillStyle=N,a.fillText(e,t,n))},[j,N]),de=()=>{L.trim()!==""&&(T?f.current?.putImageData(T,0,0):oe(),_e(L,ne,ae),B()),H(!1),X(""),Y(null),W(!1)},Te=e=>{e.key==="Enter"&&de()},Pe=u(k?"widgets.drawing_pad.exit_pan":"widgets.drawing_pad.pan_mode");return s.jsxs("div",{className:"w-full h-full flex flex-col bg-gray-100 rounded-lg shadow-md overflow-hidden",children:[s.jsxs("div",{className:"p-2 bg-gray-200 flex items-center gap-2 border-b flex-wrap",children:[s.jsxs("div",{className:"flex items-center gap-2 border-r pr-2",children:[s.jsx("button",{onClick:()=>{b(),V("draw")},className:`p-2 rounded-md ${_==="draw"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.brush"),children:s.jsx(Ye,{size:20})}),s.jsx("button",{onClick:()=>{b(),V("erase")},className:`p-2 rounded-md ${_==="erase"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.eraser"),children:s.jsx(Xe,{size:20})})]}),_==="draw"&&s.jsxs("div",{className:"flex items-center gap-2 border-r pr-2",children:[s.jsx("button",{onClick:()=>{b(),S("pencil")},className:`p-2 rounded-md ${h==="pencil"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.pencil"),children:s.jsx(De,{size:20})}),s.jsx("button",{onClick:()=>{b(),S("marker")},className:`p-2 rounded-md ${h==="marker"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.marker"),children:s.jsx(Ee,{size:20})}),s.jsx("button",{onClick:()=>{b(),S("spray")},className:`p-2 rounded-md ${h==="spray"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.spray"),children:s.jsx($e,{size:20})}),s.jsx("button",{onClick:()=>{b(),S("line")},className:`p-2 rounded-md ${h==="line"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.line"),children:s.jsx(Be,{size:20})}),s.jsx("button",{onClick:()=>{b(),S("rectangle")},className:`p-2 rounded-md ${h==="rectangle"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.rectangle"),children:s.jsx(Oe,{size:20})}),s.jsx("button",{onClick:()=>{b(),S("circle")},className:`p-2 rounded-md ${h==="circle"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.circle"),children:s.jsx(We,{size:20})}),s.jsx("button",{onClick:()=>{b(),S("arrow")},className:`p-2 rounded-md ${h==="arrow"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.arrow"),children:s.jsx(He,{size:20})}),s.jsx("button",{onClick:()=>{b(),S("text")},className:`p-2 rounded-md ${h==="text"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.text"),children:s.jsx(Le,{size:20})})]}),s.jsxs("div",{className:"flex items-center gap-4",children:[_==="draw"&&s.jsx("input",{type:"color",value:N,onChange:e=>{b(),we(e.target.value)},className:"w-8 h-8 cursor-pointer rounded-md border border-gray-300",title:u("widgets.drawing_pad.select_color")}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"range",min:"1",max:"50",value:j,onChange:e=>{b(),me(Number(e.target.value))},className:"w-24 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer",title:u("widgets.drawing_pad.brush_size")}),s.jsx("span",{className:"text-sm w-6 text-center text-gray-700",children:j})]})]}),s.jsxs("label",{htmlFor:"image-upload",className:"p-2 rounded-md hover:bg-gray-300 cursor-pointer",title:u("widgets.drawing_pad.upload_image"),children:[s.jsx(Ae,{size:20}),s.jsx("input",{id:"image-upload",type:"file",accept:"image/*",onChange:Re,className:"hidden"})]}),s.jsx("button",{onClick:Ne,className:"p-2 rounded-md hover:bg-green-300",title:u("widgets.drawing_pad.save_drawing"),children:s.jsx(Fe,{size:20})}),s.jsx("button",{onClick:Ie,className:"p-2 rounded-md hover:bg-red-300",title:u("widgets.drawing_pad.clear_all"),children:s.jsx(Ue,{size:20})}),s.jsxs("div",{className:"ml-auto flex items-center gap-2 border-l pl-2",children:[s.jsx("button",{onClick:ye,className:`p-2 rounded-md ${k?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:Pe,children:s.jsx(qe,{size:20})}),s.jsx("button",{onClick:ke,className:"p-2 rounded-md hover:bg-blue-300",title:u("widgets.drawing_pad.center_view"),children:s.jsx(Je,{size:20})})]})]}),s.jsxs("div",{className:"flex-grow w-full h-full relative bg-white",children:[s.jsx("canvas",{ref:m,onMouseDown:je,onMouseUp:e=>{if(k){I(null),B();return}h!=="text"&&le(e.nativeEvent)},onMouseLeave:e=>{k?I(null):Q&&h!=="text"&&le(e.nativeEvent)},onMouseMove:Se,className:`w-full h-full block ${k?"cursor-grab":z?"cursor-grabbing":"cursor-crosshair"}`,style:{cursor:k?z?"grabbing":"grab":"crosshair"}}),!p&&A&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-gray-400 text-lg pointer-events-none",children:u("widgets.drawing_pad.start_drawing")}),te&&s.jsx("input",{type:"text",ref:re,value:L,onChange:e=>X(e.target.value),onBlur:de,onKeyDown:Te,style:{position:"absolute",left:ne,top:ae,fontSize:`${j*2}px`,color:N,fontFamily:"Arial",backgroundColor:"rgba(255, 255, 255, 0.8)",border:"1px solid #ccc",padding:"2px 5px",zIndex:100,minWidth:"50px",outline:"none",transform:"translate(-50%, -50%)"},className:"rounded-md shadow-sm"})]})]})};export{xt as DrawingPadWidget,Ct as widgetConfig};
