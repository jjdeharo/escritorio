import{r as m,j as r}from"./vendor-react-CvxLrFbY.js";import{u as ve}from"./vendor-fflate-PjZAcS34.js";import{x as dt}from"./index-BRUjA2Tl.js";import{u as je}from"./vendor-react-i18next-CV9wn5jO.js";import{F as Ee,Q as Se,O as _e,ad as Ne,a8 as We,T as ke,y as Ae}from"./vendor-lucide-react-CYRm5Z9O.js";import"./vendor-clsx-DMbM62ou.js";import"./vendor-react-dom-ovwEKgq_.js";import"./vendor-scheduler-SPyfQU6S.js";import"./vendor-i18next-http-backend-BlWUewvL.js";import"./vendor-react-rnd-CJIym3is.js";import"./vendor-react-draggable-CHzIUO8G.js";import"./vendor-prop-types-Chjiymov.js";import"./vendor-re-resizable-Bd8fNV1d.js";import"./vendor-dnd-kit-core-C4pUYSBz.js";import"./vendor-dnd-kit-utilities-CZrAEsTl.js";import"./vendor-dnd-kit-accessibility-DKV5GxcV.js";import"./vendor-dnd-kit-sortable-BobZZm17.js";import"./vendor-framer-motion-FfyGqyL8.js";import"./vendor-motion-dom-DtvSSoo0.js";import"./vendor-motion-utils-CjIqCkNq.js";import"./vendor-i18next-Bvlggjj8.js";import"./vendor-i18next-browser-languagedetector-OJKzRF51.js";import"./vendor-html-parse-stringify-C3VvPRF8.js";import"./vendor-void-elements-SshaXqDN.js";const Ce="escritorio-digital-sites",Le=1,R="sites",L="files",oe="active-profile-name",te="active-profile-change",ae="Escritorio Principal";let H=null;const T=()=>(H||(H=new Promise((e,s)=>{const a=window.indexedDB.open(Ce,Le);a.onupgradeneeded=()=>{const o=a.result;o.objectStoreNames.contains(R)||o.createObjectStore(R,{keyPath:"id"}),o.objectStoreNames.contains(L)||o.createObjectStore(L,{keyPath:"key"}).createIndex("siteId","siteId",{unique:!1})},a.onsuccess=()=>e(a.result),a.onerror=()=>s(a.error)})),H),se=()=>{const e=window.localStorage.getItem(oe);if(!e)return ae;try{const s=JSON.parse(e);return typeof s=="string"&&s.trim()?s:e}catch{return e}},J=async(e,s,a)=>{const o=await T();return new Promise((u,i)=>{const w=o.transaction(e,s).objectStore(e),S=a(w);S.onsuccess=()=>u(S.result),S.onerror=()=>i(S.error)})},Re=async(e,s)=>{const a=s.filter(o=>!o.profileName);a.length!==0&&await J(R,"readwrite",o=>(a.forEach(u=>{o.put({...u,profileName:e})}),o.getAll()))},Ie=async e=>{const a=await J(R,"readonly",o=>o.getAll())??[];return a.some(o=>!o.profileName)?(await Re(e,a),a.map(o=>({...o,profileName:o.profileName??e})).filter(o=>o.profileName===e)):a.filter(o=>o.profileName===e)},Y=async e=>{await J(R,"readwrite",s=>s.put(e))},Pe=async e=>{const s=await T();await new Promise((a,o)=>{const u=s.transaction([R,L],"readwrite");u.objectStore(R).delete(e);const i=u.objectStore(L),w=i.index("siteId").getAllKeys(IDBKeyRange.only(e));w.onsuccess=()=>{w.result.forEach(I=>i.delete(I))},u.oncomplete=()=>a(),u.onerror=()=>o(u.error)})},Be=async e=>{const s=await T();return new Promise((a,o)=>{const w=s.transaction(L,"readonly").objectStore(L).index("siteId").getAll(IDBKeyRange.only(e));w.onsuccess=()=>a(w.result??[]),w.onerror=()=>o(w.error)})},re=async e=>{if(e.length===0)return;const s=await T();await new Promise((a,o)=>{const u=s.transaction(L,"readwrite"),i=u.objectStore(L);e.forEach(l=>i.put(l)),u.oncomplete=()=>a(),u.onerror=()=>o(u.error)})},ne=e=>{const s=e.toLowerCase();return s.endsWith(".html")||s.endsWith(".htm")?"text/html":s.endsWith(".css")?"text/css":s.endsWith(".js")?"text/javascript":s.endsWith(".json")?"application/json":s.endsWith(".svg")?"image/svg+xml":s.endsWith(".png")?"image/png":s.endsWith(".jpg")||s.endsWith(".jpeg")?"image/jpeg":s.endsWith(".webp")?"image/webp":s.endsWith(".gif")?"image/gif":s.endsWith(".woff")?"font/woff":s.endsWith(".woff2")?"font/woff2":s.endsWith(".ttf")?"font/ttf":s.endsWith(".otf")?"font/otf":s.endsWith(".ico")?"image/x-icon":"application/octet-stream"},C=e=>e.replace(/\\/g,"/").replace(/^\.?\//,""),G=(e,s)=>{if(s.startsWith("/"))return C(s.slice(1));const a=C(e).split("/");a.pop();const o=s.split("/"),u=[...a,...o],i=[];return u.forEach(l=>{!l||l==="."||(l===".."?i.pop():i.push(l))}),i.join("/")},ie=(e,s,a)=>e.replace(/url\(([^)]+)\)/g,(o,u)=>{const i=String(u).trim().replace(/^['"]|['"]$/g,"");if(i.startsWith("data:")||i.startsWith("http:")||i.startsWith("https:")||i.startsWith("blob:")||i.startsWith("#"))return o;const l=G(s,i),w=a.get(l);return w?`url("${w}")`:o}),Ue=(e,s,a,o)=>{const i=new DOMParser().parseFromString(e,"text/html"),l=(x,_)=>{Array.from(i.querySelectorAll(x)).forEach(E=>{const p=E.getAttribute(_);if(!p||p.startsWith("http:")||p.startsWith("https:")||p.startsWith("data:")||p.startsWith("blob:")||p.startsWith("#")||p.startsWith("mailto:"))return;const v=G(s,p),y=(_==="href"?o.get(v):null)||a.get(v);y&&E.setAttribute(_,y)})},w=x=>x.split(",").map(E=>E.trim()).filter(Boolean).map(E=>{const p=E.split(/\s+/),v=p[0];if(v.startsWith("http:")||v.startsWith("https:")||v.startsWith("data:")||v.startsWith("blob:")||v.startsWith("#")||v.startsWith("mailto:"))return E;const y=G(s,v),N=a.get(y);return N?(p[0]=N,p.join(" ")):E}).join(", ");return l("img[src]","src"),l("script[src]","src"),l("link[href]","href"),l("source[src]","src"),l("video[src]","src"),l("audio[src]","src"),l("iframe[src]","src"),l("a[href]","href"),l("form[action]","action"),Array.from(i.querySelectorAll("img[srcset], source[srcset]")).forEach(x=>{const _=x.getAttribute("srcset");_&&x.setAttribute("srcset",w(_))}),Array.from(i.querySelectorAll("style")).forEach(x=>{x.textContent&&(x.textContent=ie(x.textContent,s,a))}),`<!DOCTYPE html>${i.documentElement.outerHTML}`},M=e=>{if(!Number.isFinite(e))return"0 B";if(e<1024)return`${e} B`;const s=e/1024;if(s<1024)return`${s.toFixed(1)} KB`;const a=s/1024;return a<1024?`${a.toFixed(1)} MB`:`${(a/1024).toFixed(2)} GB`},$e=async()=>{if(!navigator.storage||!navigator.storage.estimate)return{usage:null,quota:null};const e=await navigator.storage.estimate();return{usage:typeof e.usage=="number"?e.usage:null,quota:typeof e.quota=="number"?e.quota:null}},it=()=>{const{t:e}=je(),[s,a]=m.useState([]),[o,u]=m.useState(null),[i,l]=m.useState(()=>se()),[w,S]=m.useState(null),[I,x]=m.useState(""),[_,$]=m.useState(null),[E,p]=m.useState(""),[v,y]=m.useState(""),[N,ce]=m.useState({usage:null,quota:null}),[O,le]=m.useState(!1),Z=m.useRef(null),q=m.useRef(null),W=m.useRef([]),z=m.useRef(!1),B=async t=>{const n=await Ie(t);n.sort((c,d)=>d.updatedAt-c.updatedAt),a(n)},U=async()=>{const t=await $e();ce(t)},D=()=>{window.dispatchEvent(new Event("storage-usage-changed"))};m.useEffect(()=>{const t=q.current;t&&(t.webkitdirectory=!0,t.setAttribute("webkitdirectory",""),t.setAttribute("directory",""))},[]),m.useEffect(()=>{const t=c=>{const d=c.detail;l(d?.name||se())},n=c=>{if(c.key===oe){if(!c.newValue){l(ae);return}try{const d=JSON.parse(c.newValue);l(typeof d=="string"&&d.trim()?d:c.newValue)}catch{l(c.newValue)}}};return window.addEventListener(te,t),window.addEventListener("storage",n),()=>{window.removeEventListener(te,t),window.removeEventListener("storage",n)}},[]),m.useEffect(()=>{B(i),U(),V()},[i]),m.useEffect(()=>{const t=()=>{B(i),U()};return window.addEventListener("local-web-data-changed",t),()=>{window.removeEventListener("local-web-data-changed",t)}},[i]),m.useEffect(()=>()=>{W.current.forEach(t=>URL.revokeObjectURL(t)),W.current=[]},[]);const de=m.useMemo(()=>{const{usage:t,quota:n}=N;if(t!=null&&n!=null){const c=Math.min(100,Math.round(t/n*100));return e("widgets.local_web.storage_usage",{used:M(t),total:M(n),percent:c})}return t!=null?e("widgets.local_web.storage_used",{used:M(t)}):e("widgets.local_web.storage_unknown")},[N,e]),ue=m.useMemo(()=>{const{usage:t,quota:n}=N;if(t==null||n==null)return"local-web-storage-neutral";const c=t/n;return c<.7?"local-web-storage-ok":c<.85?"local-web-storage-warn":"local-web-storage-danger"},[N]),Q=m.useMemo(()=>{const{usage:t,quota:n}=N;return t==null||n==null?null:Math.min(100,Math.max(0,Math.round(t/n*100)))},[N]),V=()=>{u(null),S(null),x(""),W.current.forEach(t=>URL.revokeObjectURL(t)),W.current=[]},me=()=>{if(!w)return;const t=window.screen.width,n=window.screen.height,c=window.open("","_blank",`popup=1,width=${t},height=${n},left=0,top=0`);if(!c)return;const d=I.replace(/</g,"&lt;").replace(/>/g,"&gt;");c.document.write(`<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>${d}</title>
    <style>
      html, body { margin: 0; padding: 0; height: 100%; }
      body { display: flex; flex-direction: column; font-family: sans-serif; }
      header { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0; transition: opacity 0.3s; }
      header.hidden { display: none; }
      button { border: 1px solid #ccc; background: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
      iframe { flex: 1; border: 0; width: 100%; }
    </style>
  </head>
  <body>
    <header>
      <span>${d}</span>
      <div>
        <button id="fullscreen">${e("widgets.local_web.open_fullscreen_button")}</button>
        <button id="close">${e("widgets.local_web.close_window_button")}</button>
      </div>
    </header>
    <iframe src="${w}" title="${d}"></iframe>
    <script>
      const fullBtn = document.getElementById('fullscreen');
      const closeBtn = document.getElementById('close');
      const header = document.querySelector('header');

      fullBtn.addEventListener('click', () => {
        const root = document.documentElement;
        if (root.requestFullscreen) root.requestFullscreen();
      });

      closeBtn.addEventListener('click', () => window.close());

      document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
          header.classList.add('hidden');
        } else {
          header.classList.remove('hidden');
        }
      });
    <\/script>
  </body>
</html>`),c.document.close(),c.focus()},we=async t=>{if(!window.confirm(e("widgets.local_web.confirm_extract",{name:t.name})))return;y(e("widgets.local_web.importing"));const c=await t.arrayBuffer(),d=ve(new Uint8Array(c)),b=[];if(Object.keys(d).forEach(h=>{if(h.endsWith("/")||h.startsWith("__MACOSX/"))return;const P=C(h),F=d[h],f=ne(P),A=new Blob([F],{type:f});b.push({key:"",siteId:"",path:P,blob:A,size:A.size,type:f})}),b.length===0){y(e("widgets.local_web.import_empty"));return}const j=crypto.randomUUID(),g=Date.now(),k={id:j,name:t.name.replace(/\.zip$/i,""),profileName:i,createdAt:g,updatedAt:g,fileCount:b.length,totalBytes:b.reduce((h,P)=>h+P.size,0)};b.forEach(h=>{h.siteId=j,h.key=`${j}::${h.path}`}),await Y(k),await re(b),y(e("widgets.local_web.import_done")),await B(i),await U(),D()},fe=async t=>{if(!t.length)return;y(e("widgets.local_web.importing"));const n=crypto.randomUUID(),c=Date.now(),d=[];Array.from(t).forEach(g=>{const k=C(g.webkitRelativePath||g.name),h=g.slice(0,g.size,g.type||ne(k));d.push({key:`${n}::${k}`,siteId:n,path:k,blob:h,size:h.size,type:h.type})});const b=t[0].webkitRelativePath?.split("/")[0]||t[0].name,j={id:n,name:b,profileName:i,createdAt:c,updatedAt:c,fileCount:d.length,totalBytes:d.reduce((g,k)=>g+k.size,0)};await Y(j),await re(d),y(e("widgets.local_web.import_done")),await B(i),await U(),D()},pe=async t=>{y(e("widgets.local_web.loading"));const n=await Be(t.id),c=new Map;n.forEach(f=>c.set(C(f.path),f));const d=n.find(f=>f.path.toLowerCase().endsWith("index.html"))?.path||n.find(f=>f.path.toLowerCase().endsWith("index.htm"))?.path||"";if(!d){y(e("widgets.local_web.missing_index"));return}W.current.forEach(f=>URL.revokeObjectURL(f)),W.current=[];const b=new Map;n.forEach(f=>{const A=URL.createObjectURL(f.blob);W.current.push(A),b.set(C(f.path),A)});const j=new Map;for(const f of n.filter(A=>A.path.toLowerCase().endsWith(".css")))try{const A=await f.blob.text(),xe=ie(A,f.path,b),ye=new Blob([xe],{type:"text/css"}),ee=URL.createObjectURL(ye);W.current.push(ee),j.set(C(f.path),ee)}catch{}const g=c.get(C(d));if(!g){y(e("widgets.local_web.missing_index"));return}const k=await g.blob.text(),h=Ue(k,d,b,j),P=new Blob([h],{type:"text/html"}),F=URL.createObjectURL(P);W.current.push(F),x(t.name),S(F),u(t.id),y("")},K=()=>{$(null),p("")},X=async t=>{const n=E.trim();if(!n){alert(e("widgets.local_web.rename_invalid"));return}if(n===t.name){K();return}const c={...t,name:n,updatedAt:Date.now()};await Y(c),a(d=>{const b=d.map(j=>j.id===t.id?c:j);return b.sort((j,g)=>g.updatedAt-j.updatedAt),b}),o===t.id&&x(n),K()},he=async t=>{const n=t.target.files?.[0];n&&(await we(n),t.target.value="")},be=async t=>{t.target.files&&(await fe(t.target.files),t.target.value="")},ge=async t=>{window.confirm(e("widgets.local_web.confirm_delete"))&&(o===t&&V(),await Pe(t),await B(i),await U(),D())};return r.jsxs("div",{className:"local-web-widget",children:[r.jsxs("div",{className:"local-web-header",children:[r.jsxs("div",{className:"local-web-title",children:[r.jsx(Ee,{size:18}),r.jsx("span",{children:e("widgets.local_web.title")})]}),r.jsxs("div",{className:"local-web-actions",children:[r.jsxs("button",{className:"local-web-button local-web-button-secondary",onClick:()=>le(t=>!t),children:[O?r.jsx(Se,{size:16}):r.jsx(_e,{size:16}),e(O?"widgets.local_web.expand_list":"widgets.local_web.collapse_list")]}),r.jsxs("button",{className:"local-web-button",onClick:()=>Z.current?.click(),children:[r.jsx(Ne,{size:16}),e("widgets.local_web.import_zip")]}),r.jsx("button",{className:"local-web-button",onClick:()=>q.current?.click(),children:e("widgets.local_web.import_folder")})]})]}),r.jsxs("div",{className:`local-web-storage ${ue}`,children:[r.jsx("div",{className:"local-web-storage-text",children:de}),Q!==null&&r.jsx("div",{className:"local-web-storage-bar",children:r.jsx("div",{className:"local-web-storage-bar-fill",style:{width:`${Q}%`}})})]}),r.jsxs("div",{className:`local-web-body${O?" local-web-body-collapsed":""}`,children:[r.jsxs("div",{className:`local-web-list${O?" local-web-list-collapsed":""}`,children:[v&&r.jsx("div",{className:"local-web-status",children:v}),s.length===0&&r.jsx("div",{className:"local-web-empty",children:e("widgets.local_web.empty_state")}),s.map(t=>r.jsxs("div",{className:"local-web-site",children:[r.jsxs("div",{className:"local-web-site-info",children:[_===t.id?r.jsx("input",{type:"text",value:E,onChange:n=>p(n.target.value),onBlur:()=>{if(z.current){z.current=!1;return}X(t)},onKeyDown:n=>{n.key==="Enter"&&(z.current=!0,X(t)),n.key==="Escape"&&(z.current=!0,K())},placeholder:e("widgets.local_web.rename_placeholder"),className:"local-web-site-name-input",autoFocus:!0}):r.jsx("div",{className:"local-web-site-name local-web-site-name-editable",onDoubleClick:()=>{$(t.id),p(t.name)},children:t.name}),r.jsx("div",{className:"local-web-site-meta",children:e("widgets.local_web.site_meta",{files:t.fileCount,size:M(t.totalBytes)})})]}),r.jsxs("div",{className:"local-web-site-actions",children:[r.jsx("button",{className:"local-web-icon-button",onClick:()=>pe(t),children:r.jsx(We,{size:16})}),r.jsx("button",{className:"local-web-icon-button local-web-delete",onClick:()=>ge(t.id),children:r.jsx(ke,{size:16})})]})]},t.id))]}),r.jsx("div",{className:"local-web-preview",children:w?r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"local-web-preview-header",children:[r.jsx("span",{children:I}),r.jsxs("div",{className:"local-web-preview-actions",children:[r.jsxs("button",{className:"local-web-button local-web-button-secondary",onClick:me,children:[r.jsx(Ae,{size:14}),e("widgets.local_web.open_fullscreen_window")]}),r.jsx("button",{className:"local-web-button local-web-button-secondary",onClick:V,children:e("widgets.local_web.close_preview")})]})]}),r.jsx("iframe",{className:"local-web-iframe",src:w,title:I,sandbox:"allow-scripts allow-same-origin allow-forms"})]}):r.jsx("div",{className:"local-web-preview-placeholder",children:e("widgets.local_web.preview_placeholder")})})]}),r.jsx("input",{ref:Z,type:"file",accept:".zip",className:"hidden",onChange:he}),r.jsx("input",{ref:q,type:"file",className:"hidden",onChange:be})]})};export{it as LocalWebWidget,dt as widgetConfig};
