import{u as ze,r as i,j as r,a8 as Xe,a9 as Ye,aa as De,ab as Ee,ac as Be,ad as $e,ae as Oe,af as We,ag as He,ah as Le,I as Ae,ai as Fe,T as Ue,aj as qe,a4 as Je}from"./react-vendor-C9LHBUkp.js";import{l as nt}from"./index-DIQ32RE2.js";import"./vendor-BnVc6iZf.js";import"./editor-vendor-Dlj3R3R2.js";import"./i18n-vendor-DdbEjq8F.js";const Ze=()=>{const{t:u}=ze(),f=i.useRef(null),x=i.useRef(null),[V,W]=i.useState(!1),[N,we]=i.useState("#000000"),[j,fe]=i.useState(5),[_,Z]=i.useState("draw"),[h,S]=i.useState("pencil"),[m,ee]=i.useState(null),[v,xe]=i.useState(0),[C,me]=i.useState(0),[T,X]=i.useState(null),[te,H]=i.useState(!1),[L,Y]=i.useState(""),[ne,pe]=i.useState(0),[ae,be]=i.useState(0),se=i.useRef(null),[A,ve]=i.useState(!0),[M,F]=i.useState({x:0,y:0}),[k,Ce]=i.useState(!1),y=i.useRef(null),[U,q]=i.useState(!1),D=i.useRef(typeof window<"u"&&window.devicePixelRatio||1),E=i.useRef(M),J=i.useRef(U);E.current=M,J.current=U;const b=i.useCallback(()=>{A&&ve(!1)},[A]),[z,I]=i.useState(null),B=i.useCallback((e,t)=>{if(!f.current||!y.current)return;const n=f.current,a=y.current,s=n.getContext("2d");if(s){s.clearRect(0,0,n.width,n.height);const c=D.current||1,o=Math.max(0,Math.round(e*c)),l=Math.max(0,Math.round(t*c)),g=Math.min(n.width,a.width-o),d=Math.min(n.height,a.height-l);g>0&&d>0&&s.drawImage(a,o,l,g,d,0,0,g,d)}},[]),ke=i.useCallback(()=>{F({x:0,y:0}),B(0,0)},[B]),ye=i.useCallback(()=>{Ce(!k),k||I(null)},[k]),K=i.useCallback(()=>(y.current||(y.current=document.createElement("canvas")),y.current),[]),$=i.useCallback(()=>{const e=f.current;if(!e)return;const t=K(),n=E.current,a=D.current||1,s=Math.max(e.width+Math.abs(Math.round(n.x*a)),t.width||0),c=Math.max(e.height+Math.abs(Math.round(n.y*a)),t.height||0);if(t.width<s||t.height<c){const l=document.createElement("canvas");l.width=s,l.height=c;const g=l.getContext("2d");if(g){J.current&&t.width>0&&t.height>0&&g.drawImage(t,0,0),t.width=s,t.height=c;const d=t.getContext("2d");d&&(d.clearRect(0,0,s,c),d.drawImage(l,0,0))}}const o=t.getContext("2d");if(o){const l=Math.max(0,Math.round(n.x*a)),g=Math.max(0,Math.round(n.y*a));o.drawImage(e,0,0,e.width,e.height,l,g,e.width,e.height)}q(!0)},[K]),re=i.useCallback(e=>{const t=f.current;if(!t)return{x:0,y:0};const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}},[]),ie=i.useCallback(e=>{const t=f.current;if(!t)return{x:0,y:0};const n=t.getBoundingClientRect(),a=t.width/n.width,s=t.height/n.height;return{x:(e.clientX-n.left)*a+M.x*a,y:(e.clientY-n.top)*s+M.y*s}},[M]),Me=i.useCallback(e=>{const t=f.current;if(!t)return{x:0,y:0};const n=t.getBoundingClientRect(),a=t.width/n.width,s=t.height/n.height;return{x:(e.clientX-n.left)*a+M.x*a,y:(e.clientY-n.top)*s+M.y*s}},[M]),ce=i.useCallback((e=!1)=>{const t=f.current,n=x.current;if(!t||!n)return;let a=null;if(e&&(a=n.getImageData(0,0,t.width,t.height)),e||n.clearRect(0,0,t.width,t.height),m){const s=t.width/m.width,c=t.height/m.height,o=Math.min(s,c),l=(t.width-m.width*o)/2,g=(t.height-m.height*o)/2;if(e&&a){const d=document.createElement("canvas");d.width=t.width,d.height=t.height;const p=d.getContext("2d");p&&(p.drawImage(m,0,0,m.width,m.height,l,g,m.width*o,m.height*o),p.putImageData(a,0,0),n.clearRect(0,0,t.width,t.height),n.drawImage(d,0,0))}else n.drawImage(m,0,0,m.width,m.height,l,g,m.width*o,m.height*o)}else e&&a&&n.putImageData(a,0,0)},[m]);i.useEffect(()=>{const e=f.current;if(!e)return;const t=()=>{const s=e.offsetWidth,c=e.offsetHeight,o=(typeof window<"u"?window.devicePixelRatio:1)||1;if(D.current=o,s<=0||c<=0)return;const l=Math.round(s*o),g=Math.round(c*o);if(e.width!==l||e.height!==g){const d=E.current,p=Math.max(0,Math.round(d.x*o)),R=Math.max(0,Math.round(d.y*o)),w=K();((he,ge)=>{if(w.width>=he&&w.height>=ge)return;const P=document.createElement("canvas");P.width=Math.max(he,w.width),P.height=Math.max(ge,w.height);const G=P.getContext("2d");G&&w.width>0&&w.height>0&&G.drawImage(w,0,0),w.width=P.width,w.height=P.height;const Q=w.getContext("2d");Q&&G&&(Q.clearRect(0,0,w.width,w.height),Q.drawImage(P,0,0))})(p+e.width,R+e.height);const O=w.getContext("2d");O&&e.width>0&&e.height>0&&(O.drawImage(e,0,0,e.width,e.height,p,R,e.width,e.height),J.current=!0,q(!0)),e.width=l,e.height=g,x.current=e.getContext("2d"),B(d.x,d.y)}},n=e.getContext("2d");if(!n)return;x.current=n,t();const a=new ResizeObserver(()=>{t()});return a.observe(e.parentElement||e),window.addEventListener("resize",t),()=>{a.disconnect(),window.removeEventListener("resize",t)}},[]),i.useEffect(()=>{x.current&&(x.current.globalCompositeOperation=_==="draw"?"source-over":"destination-out")},[_]);const je=e=>{if(b(),k){const a=re(e);I(a);return}if(h==="text"&&te||!x.current||!f.current)return;const{x:t,y:n}=ie(e);h==="text"?(H(!0),pe(t),be(n),Y(""),X(x.current.getImageData(0,0,f.current.width,f.current.height)),setTimeout(()=>se.current?.focus(),0)):["line","rectangle","circle","arrow"].includes(h)?(xe(t),me(n),X(x.current.getImageData(0,0,f.current.width,f.current.height))):(x.current.beginPath(),x.current.moveTo(t,n)),W(!0)},oe=(e,t,n,a,s)=>{e.save(),e.beginPath(),e.translate(t,n),e.rotate(a),e.moveTo(0,0),e.lineTo(-s,-s/2),e.lineTo(-s,s/2),e.closePath(),e.fill(),e.restore()},Se=e=>{if(k&&z){const s=re(e),c=s.x-z.x,o=s.y-z.y;if(U&&y.current){const d=y.current.getContext("2d"),p=f.current;if(d&&p){const R=E.current,w=D.current||1,ue=Math.max(0,Math.round(R.x*w)),O=Math.max(0,Math.round(R.y*w));d.drawImage(p,0,0,p.width,p.height,ue,O,p.width,p.height)}}const l={x:M.x-c,y:M.y-o};F(l),B(l.x,l.y),I(s);return}if(!V||!x.current)return;const{x:t,y:n}=ie(e),a=x.current;if(a.lineWidth=j,a.strokeStyle=N,a.fillStyle=N,T&&["line","rectangle","circle","arrow"].includes(h)){a.putImageData(T,0,0);const s=t-v,c=n-C;switch(h){case"line":a.beginPath(),a.moveTo(v,C),a.lineTo(t,n),a.stroke();break;case"rectangle":a.strokeRect(v,C,s,c);break;case"circle":const o=(v+t)/2,l=(C+n)/2,g=Math.abs(s/2),d=Math.abs(c/2);a.beginPath(),a.ellipse(o,l,g,d,0,0,2*Math.PI),a.stroke();break;case"arrow":a.beginPath(),a.moveTo(v,C),a.lineTo(t,n),a.stroke();const p=Math.atan2(n-C,t-v);oe(a,t,n,p,j*4);break}}else if(h!=="text"){switch(h){case"pencil":a.lineCap="round",a.lineJoin="round",a.lineTo(t,n),a.stroke();break;case"marker":a.lineCap="square",a.lineJoin="miter",a.lineTo(t,n),a.stroke();break;case"spray":for(let s=0;s<15;s++){const c=Math.random()*2*Math.PI,o=Math.random()*j,l=t+o*Math.cos(c),g=n+o*Math.sin(c);a.fillRect(l,g,1,1)}break}a.beginPath(),a.moveTo(t,n)}},le=e=>{if(k){I(null);return}if(!x.current)return;const t=x.current,{x:n,y:a}=Me(e);let s=n,c=a;if(["line","rectangle","circle","arrow"].includes(h)&&(isNaN(n)||isNaN(a))&&(s=v,c=C),T&&["line","rectangle","circle","arrow"].includes(h)){t.putImageData(T,0,0);const o=s-v,l=c-C;switch(h){case"line":t.beginPath(),t.moveTo(v,C),t.lineTo(s,c),t.stroke();break;case"rectangle":t.strokeRect(v,C,o,l);break;case"circle":const g=(v+s)/2,d=(C+c)/2,p=Math.abs(o/2),R=Math.abs(l/2);t.beginPath(),t.ellipse(g,d,p,R,0,0,2*Math.PI),t.stroke();break;case"arrow":t.beginPath(),t.moveTo(v,C),t.lineTo(s,c),t.stroke();const w=Math.atan2(c-C,s-v);oe(t,s,c,w,j*4);break}X(null)}else h==="text"||t.closePath();W(!1),$()},Ie=()=>{const e=f.current,t=x.current;if(e&&t&&window.confirm(u("widgets.drawing_pad.clear_confirm"))){if(ee(null),t.clearRect(0,0,e.width,e.height),H(!1),Y(""),y.current){const n=y.current.getContext("2d");n&&n.clearRect(0,0,y.current.width,y.current.height)}q(!1),F({x:0,y:0}),I(null)}},Re=e=>{b();const t=e.target.files?.[0];if(!t)return;const n=new FileReader;n.onload=a=>{const s=new Image;s.onload=()=>{ee(s),ce(),$()},s.src=a.target?.result},n.readAsDataURL(t)},Ne=()=>{const e=f.current;if(e){const t=e.toDataURL("image/png"),n=document.createElement("a");n.href=t,n.download=u("widgets.drawing_pad.default_filename"),document.body.appendChild(n),n.click(),document.body.removeChild(n)}},_e=i.useCallback((e,t,n)=>{const a=x.current;!a||!e||(a.font=`${j*2}px Arial`,a.fillStyle=N,a.fillText(e,t,n))},[j,N]),de=()=>{L.trim()!==""&&(T?x.current?.putImageData(T,0,0):ce(),_e(L,ne,ae),$()),H(!1),Y(""),X(null),W(!1)},Te=e=>{e.key==="Enter"&&de()},Pe=u(k?"widgets.drawing_pad.exit_pan":"widgets.drawing_pad.pan_mode");return r.jsxs("div",{className:"w-full h-full flex flex-col bg-gray-100 rounded-lg shadow-md overflow-hidden",children:[r.jsxs("div",{className:"p-2 bg-gray-200 flex items-center gap-2 border-b flex-wrap",children:[r.jsxs("div",{className:"flex items-center gap-2 border-r pr-2",children:[r.jsx("button",{onClick:()=>{b(),Z("draw")},className:`p-2 rounded-md ${_==="draw"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.brush"),children:r.jsx(Xe,{size:20})}),r.jsx("button",{onClick:()=>{b(),Z("erase")},className:`p-2 rounded-md ${_==="erase"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.eraser"),children:r.jsx(Ye,{size:20})})]}),_==="draw"&&r.jsxs("div",{className:"flex items-center gap-2 border-r pr-2",children:[r.jsx("button",{onClick:()=>{b(),S("pencil")},className:`p-2 rounded-md ${h==="pencil"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.pencil"),children:r.jsx(De,{size:20})}),r.jsx("button",{onClick:()=>{b(),S("marker")},className:`p-2 rounded-md ${h==="marker"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.marker"),children:r.jsx(Ee,{size:20})}),r.jsx("button",{onClick:()=>{b(),S("spray")},className:`p-2 rounded-md ${h==="spray"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.spray"),children:r.jsx(Be,{size:20})}),r.jsx("button",{onClick:()=>{b(),S("line")},className:`p-2 rounded-md ${h==="line"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.line"),children:r.jsx($e,{size:20})}),r.jsx("button",{onClick:()=>{b(),S("rectangle")},className:`p-2 rounded-md ${h==="rectangle"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.rectangle"),children:r.jsx(Oe,{size:20})}),r.jsx("button",{onClick:()=>{b(),S("circle")},className:`p-2 rounded-md ${h==="circle"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.circle"),children:r.jsx(We,{size:20})}),r.jsx("button",{onClick:()=>{b(),S("arrow")},className:`p-2 rounded-md ${h==="arrow"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.arrow"),children:r.jsx(He,{size:20})}),r.jsx("button",{onClick:()=>{b(),S("text")},className:`p-2 rounded-md ${h==="text"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.text"),children:r.jsx(Le,{size:20})})]}),r.jsxs("div",{className:"flex items-center gap-4",children:[_==="draw"&&r.jsx("input",{type:"color",value:N,onChange:e=>{b(),we(e.target.value)},className:"w-8 h-8 cursor-pointer rounded-md border border-gray-300",title:u("widgets.drawing_pad.select_color")}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("input",{type:"range",min:"1",max:"50",value:j,onChange:e=>{b(),fe(Number(e.target.value))},className:"w-24 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer",title:u("widgets.drawing_pad.brush_size")}),r.jsx("span",{className:"text-sm w-6 text-center text-gray-700",children:j})]})]}),r.jsxs("label",{htmlFor:"image-upload",className:"p-2 rounded-md hover:bg-gray-300 cursor-pointer",title:u("widgets.drawing_pad.upload_image"),children:[r.jsx(Ae,{size:20}),r.jsx("input",{id:"image-upload",type:"file",accept:"image/*",onChange:Re,className:"hidden"})]}),r.jsx("button",{onClick:Ne,className:"p-2 rounded-md hover:bg-green-300",title:u("widgets.drawing_pad.save_drawing"),children:r.jsx(Fe,{size:20})}),r.jsx("button",{onClick:Ie,className:"p-2 rounded-md hover:bg-red-300",title:u("widgets.drawing_pad.clear_all"),children:r.jsx(Ue,{size:20})}),r.jsxs("div",{className:"ml-auto flex items-center gap-2 border-l pl-2",children:[r.jsx("button",{onClick:ye,className:`p-2 rounded-md ${k?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:Pe,children:r.jsx(qe,{size:20})}),r.jsx("button",{onClick:ke,className:"p-2 rounded-md hover:bg-blue-300",title:u("widgets.drawing_pad.center_view"),children:r.jsx(Je,{size:20})})]})]}),r.jsxs("div",{className:"flex-grow w-full h-full relative bg-white",children:[r.jsx("canvas",{ref:f,onMouseDown:je,onMouseUp:e=>{if(k){I(null),$();return}h!=="text"&&le(e.nativeEvent)},onMouseLeave:e=>{k?I(null):V&&h!=="text"&&le(e.nativeEvent)},onMouseMove:Se,className:`w-full h-full block ${k?"cursor-grab":z?"cursor-grabbing":"cursor-crosshair"}`,style:{cursor:k?z?"grabbing":"grab":"crosshair"}}),!m&&A&&r.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-gray-400 text-lg pointer-events-none",children:u("widgets.drawing_pad.start_drawing")}),te&&r.jsx("input",{type:"text",ref:se,value:L,onChange:e=>Y(e.target.value),onBlur:de,onKeyDown:Te,style:{position:"absolute",left:ne,top:ae,fontSize:`${j*2}px`,color:N,fontFamily:"Arial",backgroundColor:"rgba(255, 255, 255, 0.8)",border:"1px solid #ccc",padding:"2px 5px",zIndex:100,minWidth:"50px",outline:"none",transform:"translate(-50%, -50%)"},className:"rounded-md shadow-sm"})]})]})};export{Ze as DrawingPadWidget,nt as widgetConfig};
