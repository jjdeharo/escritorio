import{M as x,a as b,m as v,d as T,g as w,f as H,e as O,j as R}from"./vendor-tiptap-core-CKFakkLY.js";import{r as C,t as _,f as y,a as B}from"./vendor-linkifyjs-DVrXeg1a.js";import{P as m,a as A}from"./vendor-prosemirror-state-NYKsNaF9.js";var P="[\0-   ᠎ -\u2029 　]",I=new RegExp(P),U=new RegExp(`${P}$`),N=new RegExp(P,"g");function V(t){return t.length===1?t[0].isLink:t.length===3&&t[1].isLink?["()","[]"].includes(t[0].value+t[2].value):!1}function W(t){return new m({key:new A("autolink"),appendTransaction:(e,s,o)=>{const l=e.some(i=>i.docChanged)&&!s.doc.eq(o.doc),a=e.some(i=>i.getMeta("preventAutolink"));if(!l||a)return;const{tr:n}=o,f=T(s.doc,[...e]);if(w(f).forEach(({newRange:i})=>{const d=H(o.doc,i,p=>p.isTextblock);let u,c;if(d.length>1)u=d[0],c=o.doc.textBetween(u.pos,u.pos+u.node.nodeSize,void 0," ");else if(d.length){const p=o.doc.textBetween(i.from,i.to," "," ");if(!U.test(p))return;u=d[0],c=o.doc.textBetween(u.pos,i.to,void 0," ")}if(u&&c){const p=c.split(I).filter(Boolean);if(p.length<=0)return!1;const g=p[p.length-1],E=u.pos+c.lastIndexOf(g);if(!g)return!1;const L=_(g).map(r=>r.toObject(t.defaultProtocol));if(!V(L))return!1;L.filter(r=>r.isLink).map(r=>({...r,from:E+r.start+1,to:E+r.end+1})).filter(r=>o.schema.marks.code?!o.doc.rangeHasMark(r.from,r.to,o.schema.marks.code):!0).filter(r=>t.validate(r.value)).filter(r=>t.shouldAutoLink(r.value)).forEach(r=>{O(r.from,r.to,o.doc).some(M=>M.mark.type===t.type)||n.addMark(r.from,r.to,t.type.create({href:r.href}))})}}),!!n.steps.length)return n}})}function D(t){return new m({key:new A("handleClickLink"),props:{handleClick:(e,s,o)=>{var l,a;if(o.button!==0||!e.editable)return!1;let n=null;if(o.target instanceof HTMLAnchorElement)n=o.target;else{let d=o.target;const u=[];for(;d.nodeName!=="DIV";)u.push(d),d=d.parentNode;n=u.find(c=>c.nodeName==="A")}if(!n)return!1;const f=R(e.state,t.type.name),k=(l=n?.href)!=null?l:f.href,i=(a=n?.target)!=null?a:f.target;return t.enableClickSelection&&t.editor.commands.extendMarkRange(t.type.name),n&&k?(window.open(k,i),!0):!1}}})}function z(t){return new m({key:new A("handlePasteLink"),props:{handlePaste:(e,s,o)=>{const{state:l}=e,{selection:a}=l,{empty:n}=a;if(n)return!1;let f="";o.content.forEach(i=>{f+=i.textContent});const k=y(f,{defaultProtocol:t.defaultProtocol}).find(i=>i.isLink&&i.value===f);return!f||!k?!1:t.editor.commands.setMark(t.type,{href:k.href})}}})}function h(t,e){const s=["http","https","ftp","ftps","mailto","tel","callto","sms","cid","xmpp"];return e&&e.forEach(o=>{const l=typeof o=="string"?o:o.scheme;l&&s.push(l)}),!t||t.replace(N,"").match(new RegExp(`^(?:(?:${s.join("|")}):|[^a-z]|[a-z0-9+.-]+(?:[^a-z+.-:]|$))`,"i"))}var j=x.create({name:"link",priority:1e3,keepOnSplit:!1,exitable:!0,onCreate(){this.options.validate&&!this.options.shouldAutoLink&&(this.options.shouldAutoLink=this.options.validate,console.warn("The `validate` option is deprecated. Rename to the `shouldAutoLink` option instead.")),this.options.protocols.forEach(t=>{if(typeof t=="string"){C(t);return}C(t.scheme,t.optionalSlashes)})},onDestroy(){B()},inclusive(){return this.options.autolink},addOptions(){return{openOnClick:!0,enableClickSelection:!1,linkOnPaste:!0,autolink:!0,protocols:[],defaultProtocol:"http",HTMLAttributes:{target:"_blank",rel:"noopener noreferrer nofollow",class:null},isAllowedUri:(t,e)=>!!h(t,e.protocols),validate:t=>!!t,shouldAutoLink:t=>!!t}},addAttributes(){return{href:{default:null,parseHTML(t){return t.getAttribute("href")}},target:{default:this.options.HTMLAttributes.target},rel:{default:this.options.HTMLAttributes.rel},class:{default:this.options.HTMLAttributes.class}}},parseHTML(){return[{tag:"a[href]",getAttrs:t=>{const e=t.getAttribute("href");return!e||!this.options.isAllowedUri(e,{defaultValidate:s=>!!h(s,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:null}}]},renderHTML({HTMLAttributes:t}){return this.options.isAllowedUri(t.href,{defaultValidate:e=>!!h(e,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?["a",v(this.options.HTMLAttributes,t),0]:["a",v(this.options.HTMLAttributes,{...t,href:""}),0]},addCommands(){return{setLink:t=>({chain:e})=>{const{href:s}=t;return this.options.isAllowedUri(s,{defaultValidate:o=>!!h(o,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?e().setMark(this.name,t).setMeta("preventAutolink",!0).run():!1},toggleLink:t=>({chain:e})=>{const{href:s}=t||{};return s&&!this.options.isAllowedUri(s,{defaultValidate:o=>!!h(o,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:e().toggleMark(this.name,t,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()},unsetLink:()=>({chain:t})=>t().unsetMark(this.name,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()}},addPasteRules(){return[b({find:t=>{const e=[];if(t){const{protocols:s,defaultProtocol:o}=this.options,l=y(t).filter(a=>a.isLink&&this.options.isAllowedUri(a.value,{defaultValidate:n=>!!h(n,s),protocols:s,defaultProtocol:o}));l.length&&l.forEach(a=>e.push({text:a.value,data:{href:a.href},index:a.start}))}return e},type:this.type,getAttributes:t=>{var e;return{href:(e=t.data)==null?void 0:e.href}}})]},addProseMirrorPlugins(){const t=[],{protocols:e,defaultProtocol:s}=this.options;return this.options.autolink&&t.push(W({type:this.type,defaultProtocol:this.options.defaultProtocol,validate:o=>this.options.isAllowedUri(o,{defaultValidate:l=>!!h(l,e),protocols:e,defaultProtocol:s}),shouldAutoLink:this.options.shouldAutoLink})),this.options.openOnClick===!0&&t.push(D({type:this.type,editor:this.editor,enableClickSelection:this.options.enableClickSelection})),this.options.linkOnPaste&&t.push(z({editor:this.editor,defaultProtocol:this.options.defaultProtocol,type:this.type})),t}});export{j as L};
