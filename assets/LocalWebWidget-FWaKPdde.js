import{c as ve,u as je,r as w,j as n,F as _e,T as Ee,A as Se,B as Ne}from"./index-BZJQt2-U.js";import{C as Ke}from"./index-BZJQt2-U.js";import{a as We,C as ke}from"./chevron-right-C-RED3Is.js";import{E as Ae}from"./eye-BTEyszzv.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],Le=ve("cloud-upload",Ce),Re="escritorio-digital-sites",Ie=1,R="sites",L="files",oe="active-profile-name",te="active-profile-change",ae="Escritorio Principal";let H=null;const F=()=>(H||(H=new Promise((e,s)=>{const a=window.indexedDB.open(Re,Ie);a.onupgradeneeded=()=>{const o=a.result;o.objectStoreNames.contains(R)||o.createObjectStore(R,{keyPath:"id"}),o.objectStoreNames.contains(L)||o.createObjectStore(L,{keyPath:"key"}).createIndex("siteId","siteId",{unique:!1})},a.onsuccess=()=>e(a.result),a.onerror=()=>s(a.error)})),H),se=()=>{const e=window.localStorage.getItem(oe);if(!e)return ae;try{const s=JSON.parse(e);return typeof s=="string"&&s.trim()?s:e}catch{return e}},J=async(e,s,a)=>{const o=await F();return new Promise((u,i)=>{const f=o.transaction(e,s).objectStore(e),E=a(f);E.onsuccess=()=>u(E.result),E.onerror=()=>i(E.error)})},Be=async(e,s)=>{const a=s.filter(o=>!o.profileName);a.length!==0&&await J(R,"readwrite",o=>(a.forEach(u=>{o.put({...u,profileName:e})}),o.getAll()))},Pe=async e=>{const a=await J(R,"readonly",o=>o.getAll())??[];return a.some(o=>!o.profileName)?(await Be(e,a),a.map(o=>({...o,profileName:o.profileName??e})).filter(o=>o.profileName===e)):a.filter(o=>o.profileName===e)},Y=async e=>{await J(R,"readwrite",s=>s.put(e))},Ue=async e=>{const s=await F();await new Promise((a,o)=>{const u=s.transaction([R,L],"readwrite");u.objectStore(R).delete(e);const i=u.objectStore(L),f=i.index("siteId").getAllKeys(IDBKeyRange.only(e));f.onsuccess=()=>{f.result.forEach(I=>i.delete(I))},u.oncomplete=()=>a(),u.onerror=()=>o(u.error)})},$e=async e=>{const s=await F();return new Promise((a,o)=>{const f=s.transaction(L,"readonly").objectStore(L).index("siteId").getAll(IDBKeyRange.only(e));f.onsuccess=()=>a(f.result??[]),f.onerror=()=>o(f.error)})},ne=async e=>{if(e.length===0)return;const s=await F();await new Promise((a,o)=>{const u=s.transaction(L,"readwrite"),i=u.objectStore(L);e.forEach(l=>i.put(l)),u.oncomplete=()=>a(),u.onerror=()=>o(u.error)})},re=e=>{const s=e.toLowerCase();return s.endsWith(".html")||s.endsWith(".htm")?"text/html":s.endsWith(".css")?"text/css":s.endsWith(".js")?"text/javascript":s.endsWith(".json")?"application/json":s.endsWith(".svg")?"image/svg+xml":s.endsWith(".png")?"image/png":s.endsWith(".jpg")||s.endsWith(".jpeg")?"image/jpeg":s.endsWith(".webp")?"image/webp":s.endsWith(".gif")?"image/gif":s.endsWith(".woff")?"font/woff":s.endsWith(".woff2")?"font/woff2":s.endsWith(".ttf")?"font/ttf":s.endsWith(".otf")?"font/otf":s.endsWith(".ico")?"image/x-icon":"application/octet-stream"},C=e=>e.replace(/\\/g,"/").replace(/^\.?\//,""),G=(e,s)=>{if(s.startsWith("/"))return C(s.slice(1));const a=C(e).split("/");a.pop();const o=s.split("/"),u=[...a,...o],i=[];return u.forEach(l=>{!l||l==="."||(l===".."?i.pop():i.push(l))}),i.join("/")},ie=(e,s,a)=>e.replace(/url\(([^)]+)\)/g,(o,u)=>{const i=String(u).trim().replace(/^['"]|['"]$/g,"");if(i.startsWith("data:")||i.startsWith("http:")||i.startsWith("https:")||i.startsWith("blob:")||i.startsWith("#"))return o;const l=G(s,i),f=a.get(l);return f?`url("${f}")`:o}),Me=(e,s,a,o)=>{const i=new DOMParser().parseFromString(e,"text/html"),l=(x,S)=>{Array.from(i.querySelectorAll(x)).forEach(_=>{const p=_.getAttribute(S);if(!p||p.startsWith("http:")||p.startsWith("https:")||p.startsWith("data:")||p.startsWith("blob:")||p.startsWith("#")||p.startsWith("mailto:"))return;const v=G(s,p),y=(S==="href"?o.get(v):null)||a.get(v);y&&_.setAttribute(S,y)})},f=x=>x.split(",").map(_=>_.trim()).filter(Boolean).map(_=>{const p=_.split(/\s+/),v=p[0];if(v.startsWith("http:")||v.startsWith("https:")||v.startsWith("data:")||v.startsWith("blob:")||v.startsWith("#")||v.startsWith("mailto:"))return _;const y=G(s,v),N=a.get(y);return N?(p[0]=N,p.join(" ")):_}).join(", ");return l("img[src]","src"),l("script[src]","src"),l("link[href]","href"),l("source[src]","src"),l("video[src]","src"),l("audio[src]","src"),l("iframe[src]","src"),l("a[href]","href"),l("form[action]","action"),Array.from(i.querySelectorAll("img[srcset], source[srcset]")).forEach(x=>{const S=x.getAttribute("srcset");S&&x.setAttribute("srcset",f(S))}),Array.from(i.querySelectorAll("style")).forEach(x=>{x.textContent&&(x.textContent=ie(x.textContent,s,a))}),`<!DOCTYPE html>${i.documentElement.outerHTML}`},q=e=>{if(!Number.isFinite(e))return"0 B";if(e<1024)return`${e} B`;const s=e/1024;if(s<1024)return`${s.toFixed(1)} KB`;const a=s/1024;return a<1024?`${a.toFixed(1)} MB`:`${(a/1024).toFixed(2)} GB`},ze=async()=>{if(!navigator.storage||!navigator.storage.estimate)return{usage:null,quota:null};const e=await navigator.storage.estimate();return{usage:typeof e.usage=="number"?e.usage:null,quota:typeof e.quota=="number"?e.quota:null}},Te=()=>{const{t:e}=je(),[s,a]=w.useState([]),[o,u]=w.useState(null),[i,l]=w.useState(()=>se()),[f,E]=w.useState(null),[I,x]=w.useState(""),[S,$]=w.useState(null),[_,p]=w.useState(""),[v,y]=w.useState(""),[N,ce]=w.useState({usage:null,quota:null}),[M,le]=w.useState(!1),Z=w.useRef(null),T=w.useRef(null),W=w.useRef([]),z=w.useRef(!1),P=async t=>{const r=await Pe(t);r.sort((c,d)=>d.updatedAt-c.updatedAt),a(r)},U=async()=>{const t=await ze();ce(t)},D=()=>{window.dispatchEvent(new Event("storage-usage-changed"))};w.useEffect(()=>{const t=T.current;t&&(t.webkitdirectory=!0,t.setAttribute("webkitdirectory",""),t.setAttribute("directory",""))},[]),w.useEffect(()=>{const t=c=>{const d=c.detail;l(d?.name||se())},r=c=>{if(c.key===oe){if(!c.newValue){l(ae);return}try{const d=JSON.parse(c.newValue);l(typeof d=="string"&&d.trim()?d:c.newValue)}catch{l(c.newValue)}}};return window.addEventListener(te,t),window.addEventListener("storage",r),()=>{window.removeEventListener(te,t),window.removeEventListener("storage",r)}},[]),w.useEffect(()=>{P(i),U(),V()},[i]),w.useEffect(()=>{const t=()=>{P(i),U()};return window.addEventListener("local-web-data-changed",t),()=>{window.removeEventListener("local-web-data-changed",t)}},[i]),w.useEffect(()=>()=>{W.current.forEach(t=>URL.revokeObjectURL(t)),W.current=[]},[]);const de=w.useMemo(()=>{const{usage:t,quota:r}=N;if(t!=null&&r!=null){const c=Math.min(100,Math.round(t/r*100));return e("widgets.local_web.storage_usage",{used:q(t),total:q(r),percent:c})}return t!=null?e("widgets.local_web.storage_used",{used:q(t)}):e("widgets.local_web.storage_unknown")},[N,e]),ue=w.useMemo(()=>{const{usage:t,quota:r}=N;if(t==null||r==null)return"local-web-storage-neutral";const c=t/r;return c<.7?"local-web-storage-ok":c<.85?"local-web-storage-warn":"local-web-storage-danger"},[N]),X=w.useMemo(()=>{const{usage:t,quota:r}=N;return t==null||r==null?null:Math.min(100,Math.max(0,Math.round(t/r*100)))},[N]),V=()=>{u(null),E(null),x(""),W.current.forEach(t=>URL.revokeObjectURL(t)),W.current=[]},we=()=>{if(!f)return;const t=window.screen.width,r=window.screen.height,c=window.open("","_blank",`popup=1,width=${t},height=${r},left=0,top=0`);if(!c)return;const d=I.replace(/</g,"&lt;").replace(/>/g,"&gt;");c.document.write(`<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>${d}</title>
    <style>
      html, body { margin: 0; padding: 0; height: 100%; }
      body { display: flex; flex-direction: column; font-family: sans-serif; }
      header { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0; transition: opacity 0.3s; }
      header.hidden { display: none; }
      button { border: 1px solid #ccc; background: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
      iframe { flex: 1; border: 0; width: 100%; }
    </style>
  </head>
  <body>
    <header>
      <span>${d}</span>
      <div>
        <button id="fullscreen">${e("widgets.local_web.open_fullscreen_button")}</button>
        <button id="close">${e("widgets.local_web.close_window_button")}</button>
      </div>
    </header>
    <iframe src="${f}" title="${d}"></iframe>
    <script>
      const fullBtn = document.getElementById('fullscreen');
      const closeBtn = document.getElementById('close');
      const header = document.querySelector('header');

      fullBtn.addEventListener('click', () => {
        const root = document.documentElement;
        if (root.requestFullscreen) root.requestFullscreen();
      });

      closeBtn.addEventListener('click', () => window.close());

      document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
          header.classList.add('hidden');
        } else {
          header.classList.remove('hidden');
        }
      });
    <\/script>
  </body>
</html>`),c.document.close(),c.focus()},fe=async t=>{if(!window.confirm(e("widgets.local_web.confirm_extract",{name:t.name})))return;y(e("widgets.local_web.importing"));const c=await t.arrayBuffer(),d=Ne(new Uint8Array(c)),b=[];if(Object.keys(d).forEach(h=>{if(h.endsWith("/")||h.startsWith("__MACOSX/"))return;const B=C(h),O=d[h],m=re(B),A=new Blob([O],{type:m});b.push({key:"",siteId:"",path:B,blob:A,size:A.size,type:m})}),b.length===0){y(e("widgets.local_web.import_empty"));return}const j=crypto.randomUUID(),g=Date.now(),k={id:j,name:t.name.replace(/\.zip$/i,""),profileName:i,createdAt:g,updatedAt:g,fileCount:b.length,totalBytes:b.reduce((h,B)=>h+B.size,0)};b.forEach(h=>{h.siteId=j,h.key=`${j}::${h.path}`}),await Y(k),await ne(b),y(e("widgets.local_web.import_done")),await P(i),await U(),D()},me=async t=>{if(!t.length)return;y(e("widgets.local_web.importing"));const r=crypto.randomUUID(),c=Date.now(),d=[];Array.from(t).forEach(g=>{const k=C(g.webkitRelativePath||g.name),h=g.slice(0,g.size,g.type||re(k));d.push({key:`${r}::${k}`,siteId:r,path:k,blob:h,size:h.size,type:h.type})});const b=t[0].webkitRelativePath?.split("/")[0]||t[0].name,j={id:r,name:b,profileName:i,createdAt:c,updatedAt:c,fileCount:d.length,totalBytes:d.reduce((g,k)=>g+k.size,0)};await Y(j),await ne(d),y(e("widgets.local_web.import_done")),await P(i),await U(),D()},pe=async t=>{y(e("widgets.local_web.loading"));const r=await $e(t.id),c=new Map;r.forEach(m=>c.set(C(m.path),m));const d=r.find(m=>m.path.toLowerCase().endsWith("index.html"))?.path||r.find(m=>m.path.toLowerCase().endsWith("index.htm"))?.path||"";if(!d){y(e("widgets.local_web.missing_index"));return}W.current.forEach(m=>URL.revokeObjectURL(m)),W.current=[];const b=new Map;r.forEach(m=>{const A=URL.createObjectURL(m.blob);W.current.push(A),b.set(C(m.path),A)});const j=new Map;for(const m of r.filter(A=>A.path.toLowerCase().endsWith(".css")))try{const A=await m.blob.text(),xe=ie(A,m.path,b),ye=new Blob([xe],{type:"text/css"}),ee=URL.createObjectURL(ye);W.current.push(ee),j.set(C(m.path),ee)}catch{}const g=c.get(C(d));if(!g){y(e("widgets.local_web.missing_index"));return}const k=await g.blob.text(),h=Me(k,d,b,j),B=new Blob([h],{type:"text/html"}),O=URL.createObjectURL(B);W.current.push(O),x(t.name),E(O),u(t.id),y("")},K=()=>{$(null),p("")},Q=async t=>{const r=_.trim();if(!r){alert(e("widgets.local_web.rename_invalid"));return}if(r===t.name){K();return}const c={...t,name:r,updatedAt:Date.now()};await Y(c),a(d=>{const b=d.map(j=>j.id===t.id?c:j);return b.sort((j,g)=>g.updatedAt-j.updatedAt),b}),o===t.id&&x(r),K()},he=async t=>{const r=t.target.files?.[0];r&&(await fe(r),t.target.value="")},be=async t=>{t.target.files&&(await me(t.target.files),t.target.value="")},ge=async t=>{window.confirm(e("widgets.local_web.confirm_delete"))&&(o===t&&V(),await Ue(t),await P(i),await U(),D())};return n.jsxs("div",{className:"local-web-widget",children:[n.jsxs("div",{className:"local-web-header",children:[n.jsxs("div",{className:"local-web-title",children:[n.jsx(_e,{size:18}),n.jsx("span",{children:e("widgets.local_web.title")})]}),n.jsxs("div",{className:"local-web-actions",children:[n.jsxs("button",{className:"local-web-button local-web-button-secondary",onClick:()=>le(t=>!t),children:[M?n.jsx(We,{size:16}):n.jsx(ke,{size:16}),e(M?"widgets.local_web.expand_list":"widgets.local_web.collapse_list")]}),n.jsxs("button",{className:"local-web-button",onClick:()=>Z.current?.click(),children:[n.jsx(Le,{size:16}),e("widgets.local_web.import_zip")]}),n.jsx("button",{className:"local-web-button",onClick:()=>T.current?.click(),children:e("widgets.local_web.import_folder")})]})]}),n.jsxs("div",{className:`local-web-storage ${ue}`,children:[n.jsx("div",{className:"local-web-storage-text",children:de}),X!==null&&n.jsx("div",{className:"local-web-storage-bar",children:n.jsx("div",{className:"local-web-storage-bar-fill",style:{width:`${X}%`}})})]}),n.jsxs("div",{className:`local-web-body${M?" local-web-body-collapsed":""}`,children:[n.jsxs("div",{className:`local-web-list${M?" local-web-list-collapsed":""}`,children:[v&&n.jsx("div",{className:"local-web-status",children:v}),s.length===0&&n.jsx("div",{className:"local-web-empty",children:e("widgets.local_web.empty_state")}),s.map(t=>n.jsxs("div",{className:"local-web-site",children:[n.jsxs("div",{className:"local-web-site-info",children:[S===t.id?n.jsx("input",{type:"text",value:_,onChange:r=>p(r.target.value),onBlur:()=>{if(z.current){z.current=!1;return}Q(t)},onKeyDown:r=>{r.key==="Enter"&&(z.current=!0,Q(t)),r.key==="Escape"&&(z.current=!0,K())},placeholder:e("widgets.local_web.rename_placeholder"),className:"local-web-site-name-input",autoFocus:!0}):n.jsx("div",{className:"local-web-site-name local-web-site-name-editable",onDoubleClick:()=>{$(t.id),p(t.name)},children:t.name}),n.jsx("div",{className:"local-web-site-meta",children:e("widgets.local_web.site_meta",{files:t.fileCount,size:q(t.totalBytes)})})]}),n.jsxs("div",{className:"local-web-site-actions",children:[n.jsx("button",{className:"local-web-icon-button",onClick:()=>pe(t),children:n.jsx(Ae,{size:16})}),n.jsx("button",{className:"local-web-icon-button local-web-delete",onClick:()=>ge(t.id),children:n.jsx(Ee,{size:16})})]})]},t.id))]}),n.jsx("div",{className:"local-web-preview",children:f?n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"local-web-preview-header",children:[n.jsx("span",{children:I}),n.jsxs("div",{className:"local-web-preview-actions",children:[n.jsxs("button",{className:"local-web-button local-web-button-secondary",onClick:we,children:[n.jsx(Se,{size:14}),e("widgets.local_web.open_fullscreen_window")]}),n.jsx("button",{className:"local-web-button local-web-button-secondary",onClick:V,children:e("widgets.local_web.close_preview")})]})]}),n.jsx("iframe",{className:"local-web-iframe",src:f,title:I,sandbox:"allow-scripts allow-same-origin allow-forms"})]}):n.jsx("div",{className:"local-web-preview-placeholder",children:e("widgets.local_web.preview_placeholder")})})]}),n.jsx("input",{ref:Z,type:"file",accept:".zip",className:"hidden",onChange:he}),n.jsx("input",{ref:T,type:"file",className:"hidden",onChange:be})]})};export{Te as LocalWebWidget,Ke as widgetConfig};
